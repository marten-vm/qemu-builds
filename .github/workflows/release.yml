name: QEMU Build and Release

on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version_tag: ${{ steps.check.outputs.version_tag }}
      version_num: ${{ steps.check.outputs.version_num }}
    steps:
      - name: Check for new stable QEMU version
        id: check
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          UPSTREAM_TAG=$(git ls-remote --tags --refs https://gitlab.com/qemu-project/qemu.git \
            | awk -F/ '{print $3}' \
            | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n1)
          
          VERSION_NUM="${UPSTREAM_TAG#v}"
          # Fetch latest release tag, surfacing errors if it fails
          if ! LOCAL_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName'); then
             echo "Warning: Failed to fetch local release tag. Defaulting to v0.0.0"
             LOCAL_TAG="v0.0.0"
          fi
          
          # Handle empty result if command succeeds but finds no releases
          if [ -z "$LOCAL_TAG" ]; then
             LOCAL_TAG="v0.0.0"
          fi

          echo "Local Tag determined as: $LOCAL_TAG"
          echo "Upstream Tag: $UPSTREAM_TAG"

          if [ "$UPSTREAM_TAG" != "$LOCAL_TAG" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "version_tag=$UPSTREAM_TAG" >> $GITHUB_OUTPUT
            echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  download-source:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Download QEMU Source
        env:
          VERSION: ${{ needs.check-version.outputs.version_num }}
        run: |
          URL="https://download.qemu.org/qemu-${VERSION}.tar.xz"
          wget -q "$URL" -O qemu-source.tar.xz

      - name: Upload Source Artifact
        uses: actions/upload-artifact@v4
        with:
          name: qemu-source
          path: qemu-source.tar.xz
          retention-days: 1

  build-and-release-windows:
    needs: [check-version, download-source]
    if: needs.check-version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: windows-2022
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - uses: actions/checkout@v4

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          cache: true
          install: >-
            base-devel
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-python
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-zstd
            mingw-w64-x86_64-libslirp
            ccache
            wget
            tar
            bzip2
            git
            zip

      - name: Restore CCache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-mingw64-${{ github.sha }}
          restore-keys: ccache-mingw64-

      - name: Download Source Artifact
        uses: actions/download-artifact@v4
        with:
          name: qemu-source
          path: .

      - name: Download and Configure
        id: build-prep
        env:
          VERSION: ${{ needs.check-version.outputs.version_num }}
        run: |
          export CCACHE_DIR="$(pwd)/.ccache"
          export CCACHE_COMPRESS=1
          export CCACHE_MAXSIZE=500M
          mkdir -p .ccache
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          
          export CC="ccache gcc"
          export CXX="ccache g++"

          # Source downloaded from artifact
          
          tar -xf qemu-source.tar.xz --exclude="*/roms/*" --exclude="*/tests/lcitool/*" || echo "Tar warning: Symlinks failed, proceeding..."
          
          mv "qemu-${VERSION}" qemu-src
          
          cd qemu-src
          mkdir build
          cd build
          
          INSTALL_DIR="$(pwd -W)/qemu-install"
          
          FLAGS="--prefix=$INSTALL_DIR \
          --target-list=x86_64-softmmu \
          --extra-cflags=-O2 \
          --extra-ldflags=-s \
          --enable-whpx \
          --enable-slirp \
          --disable-sdl \
          --disable-gtk \
          --disable-curses \
          --disable-vnc \
          --disable-gnutls \
          --disable-glusterfs \
          --disable-libnfs \
          --disable-libiscsi \
          --disable-rbd \
          --disable-xen \
          --disable-docs \
          --disable-debug-info \
          --disable-capstone \
          --disable-libssh \
          --disable-snappy \
          --disable-bzip2 \
          --disable-lzo \
          --disable-zstd \
          --disable-seccomp \
          --disable-guest-agent \
          --disable-vte \
          --disable-spice \
          --disable-curl \
          --disable-smartcard \
          --disable-usb-redir \
          --disable-libusb \
          --disable-opengl \
          --disable-virglrenderer \
          --disable-iconv \
          --disable-pixman \
          --disable-fdt \
          --disable-dbus-display \
          --disable-nettle \
          --disable-hv-balloon \
          --disable-png"

          echo "BUILD_FLAGS=$FLAGS" >> $GITHUB_ENV
          
          ../configure $FLAGS

      - name: Build QEMU
        run: |
          cd qemu-src/build
          ccache -z
          ninja qemu-system-x86_64.exe -j$(nproc)
          ninja qemu-img.exe -j$(nproc)
          ccache -s

      - name: Package and Bundle
        run: |
          SRC_DIR="qemu-src"
          BUILD_DIR="qemu-src/build"
          RELEASE_DIR="qemu-release"
          LICENSE_DIR="$RELEASE_DIR/licenses"
          ARCHIVE_NAME="qemu-windows-x86_64-${{ needs.check-version.outputs.version_tag }}.tar.zst"
          
          echo "Preparing release dir..."
          rm -rf "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR" "$LICENSE_DIR"

          echo "Copying core binaries..."
          cp "$BUILD_DIR/qemu-system-x86_64.exe" "$RELEASE_DIR/"
          cp "$BUILD_DIR/qemu-img.exe" "$RELEASE_DIR/"
          
          echo "Copying firmware..."
          BIOS_SRC="$SRC_DIR/pc-bios"
          RELEASE_SHARE="$RELEASE_DIR/share"
          mkdir -p "$RELEASE_SHARE"
          # Basic BIOS/UEFI
          cp "$BIOS_SRC/bios-256k.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/bios.bin" "$RELEASE_SHARE/"
          
          # EDK2 (Compressed)
          cp "$BIOS_SRC/edk2-x86_64-code.fd.bz2" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/edk2-i386-vars.fd.bz2" "$RELEASE_SHARE/"
          bzip2 -d "$RELEASE_SHARE"/*.bz2
          
          # KVM/VAPIC
          cp "$BIOS_SRC/kvmvapic.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/multiboot.bin" "$RELEASE_SHARE/"
          
          # Linux Boot
          cp "$BIOS_SRC/linuxboot.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/linuxboot_dma.bin" "$RELEASE_SHARE/"
          
          # VGA BIOSes
          cp "$BIOS_SRC/vgabios.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/vgabios-cirrus.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/vgabios-qxl.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/vgabios-stdvga.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/vgabios-virtio.bin" "$RELEASE_SHARE/"
          cp "$BIOS_SRC/vgabios-vmware.bin" "$RELEASE_SHARE/"
          
          # Network Boot (PXE/EFI)
          cp "$BIOS_SRC"/efi-*.rom "$RELEASE_SHARE/"
          cp "$BIOS_SRC"/pxe-*.rom "$RELEASE_SHARE/"

          NOTICE_FILE="$RELEASE_DIR/NOTICE.txt"
          echo "QEMU Windows Release" > "$NOTICE_FILE"
          echo "Version: ${{ needs.check-version.outputs.version_tag }}" >> "$NOTICE_FILE"
          echo "Build Date: $(date)" >> "$NOTICE_FILE"
          echo "----------------------------------------" >> "$NOTICE_FILE"
          echo "Build Configuration:" >> "$NOTICE_FILE"
          echo "${{ env.BUILD_FLAGS }}" >> "$NOTICE_FILE"
          echo "----------------------------------------" >> "$NOTICE_FILE"
          echo "Compiler Version:" >> "$NOTICE_FILE"
          gcc --version | head -n 1 >> "$NOTICE_FILE"
          echo "" >> "$NOTICE_FILE"
          echo "Licensing: GPL/LGPL" >> "$NOTICE_FILE"

          echo "Resolving DLLs..."
          find "$RELEASE_DIR" -name "*.exe" -print0 | xargs -0 ldd | \
          grep -i "/mingw64/" | awk '{print $3}' | sort -u | \
          xargs -I '{}' cp '{}' "$RELEASE_DIR/"

          cp /mingw64/bin/libgcc_s_seh-1.dll \
             /mingw64/bin/libstdc++-6.dll \
             /mingw64/bin/libwinpthread-1.dll \
             /mingw64/bin/libslirp-0.dll \
             /mingw64/bin/zlib1.dll \
             "$RELEASE_DIR/" 2>/dev/null || true

          echo "Collecting Licenses..."
          [ -f "$SRC_DIR/COPYING" ] && cp "$SRC_DIR/COPYING" "$LICENSE_DIR/QEMU_COPYING.txt"
          [ -f "$SRC_DIR/COPYING.LIB" ] && cp "$SRC_DIR/COPYING.LIB" "$LICENSE_DIR/QEMU_COPYING.LIB.txt"
          [ -f "$SRC_DIR/LICENSE" ] && cp "$SRC_DIR/LICENSE" "$LICENSE_DIR/QEMU_LICENSE.txt"

          echo "Compressing..."
          tar -C "$RELEASE_DIR" -cf - . | zstd -19 -T0 -o "$ARCHIVE_NAME"
          
          echo "artifact_path=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-windows
          path: ${{ env.artifact_path }}
          retention-days: 1


  build-and-release-macos:
    needs: [check-version, download-source]
    if: needs.check-version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-15-intel
            arch: x86_64
            target: x86_64-softmmu
          - os: macos-latest
            arch: aarch64
            target: aarch64-softmmu
    env:
      MACOSX_DEPLOYMENT_TARGET: '13.0'

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          brew install ninja glib pixman pkg-config ccache zstd dtc
          
      - name: Restore CCache
        uses: actions/cache@v4
        with:
          path: /Users/runner/Library/Caches/ccache
          key: ccache-macos-${{ matrix.arch }}-${{ github.sha }}
          restore-keys: ccache-macos-${{ matrix.arch }}-

      - name: Download Source Artifact
        uses: actions/download-artifact@v4
        with:
          name: qemu-source
          path: .

      - name: Download and Configure
        id: build-prep
        env:
          VERSION: ${{ needs.check-version.outputs.version_num }}
        run: |
          export CCACHE_DIR="/Users/runner/Library/Caches/ccache"
          export CCACHE_COMPRESS=1
          export CCACHE_MAXSIZE=500M
          mkdir -p $CCACHE_DIR
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          
          export CC="ccache clang"
          export CXX="ccache clang++"
          export OBJC="ccache clang"

          # Source downloaded from artifact
          
          tar -xf qemu-source.tar.xz --exclude="*/roms/*" --exclude="*/tests/lcitool/*" || echo "Tar warning: Symlinks failed, proceeding..."
          
          mv "qemu-${VERSION}" qemu-src
          
          cd qemu-src
          mkdir build
          cd build
          
          INSTALL_DIR="$(pwd)/qemu-install"
          
          FLAGS="--prefix=$INSTALL_DIR \
          --target-list=${{ matrix.target }} \
          --extra-cflags=-O2 \
          --extra-ldflags=-s \
          --extra-ldflags=-headerpad_max_install_names \
          --enable-hvf \
          --enable-slirp \
          --disable-cocoa \
          --disable-sdl \
          --disable-gtk \
          --disable-curses \
          --disable-vnc \
          --disable-gnutls \
          --disable-glusterfs \
          --disable-libnfs \
          --disable-libiscsi \
          --disable-rbd \
          --disable-xen \
          --disable-docs \
          --disable-debug-info \
          --disable-capstone \
          --disable-libssh \
          --disable-snappy \
          --disable-bzip2 \
          --disable-lzo \
          --disable-zstd \
          --disable-seccomp \
          --disable-guest-agent \
          --disable-vte \
          --disable-spice \
          --disable-curl \
          --disable-smartcard \
          --disable-usb-redir \
          --disable-libusb \
          --disable-opengl \
          --disable-virglrenderer \
          --disable-iconv \
          --disable-dbus-display \
          --disable-nettle \
          --disable-hv-balloon \
          --disable-png"

          echo "BUILD_FLAGS=$FLAGS" >> $GITHUB_ENV
          
          ../configure $FLAGS

      - name: Build QEMU
        run: |
          cd qemu-src/build
          ccache -z
          ninja qemu-system-${{ matrix.arch }} -j$(sysctl -n hw.ncpu)
          ninja qemu-img -j$(sysctl -n hw.ncpu)
          # Install to qemu-install so we can find libslirp and other internal libs
          ninja install
          ccache -s

      - name: Package and Bundle
        run: |
          SRC_DIR="qemu-src"
          BUILD_DIR="qemu-src/build"
          RELEASE_DIR="qemu-release"
          LICENSE_DIR="$RELEASE_DIR/licenses"
          ARCHIVE_NAME="qemu-macos-${{ matrix.arch }}-${{ needs.check-version.outputs.version_tag }}.tar.zst"
          
          echo "Preparing release dir..."
          rm -rf "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR/bin" "$LICENSE_DIR"

          echo "Copying core binaries..."
          cp "$BUILD_DIR/qemu-system-${{ matrix.arch }}" "$RELEASE_DIR/bin/"
          cp "$BUILD_DIR/qemu-img" "$RELEASE_DIR/bin/"
          
          echo "Copying firmware..."
          BIOS_SRC="$SRC_DIR/pc-bios"
          RELEASE_SHARE="$RELEASE_DIR/share/qemu"
          mkdir -p "$RELEASE_SHARE"
          
          if [ "${{ matrix.arch }}" = "x86_64" ]; then
             cp "$BIOS_SRC/bios-256k.bin" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/bios.bin" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/kvmvapic.bin" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/multiboot.bin" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/linuxboot.bin" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/linuxboot_dma.bin" "$RELEASE_SHARE/"
             cp "$BIOS_SRC"/vgabios*.bin "$RELEASE_SHARE/"
             cp "$BIOS_SRC/efi-e1000.rom" "$RELEASE_SHARE/"
             cp "$BIOS_SRC"/pxe-*.rom "$RELEASE_SHARE/"
             
             # EDK2 (Compressed)
             cp "$BIOS_SRC/edk2-x86_64-code.fd.bz2" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/edk2-i386-vars.fd.bz2" "$RELEASE_SHARE/"
          else
             # aarch64 firmware
             cp "$BIOS_SRC/edk2-aarch64-code.fd.bz2" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/edk2-arm-code.fd.bz2" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/edk2-arm-vars.fd.bz2" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/efi-e1000.rom" "$RELEASE_SHARE/"
             cp "$BIOS_SRC/efi-virtio.rom" "$RELEASE_SHARE/"
          fi
          
          # Decompress any bz2 files
          if ls "$RELEASE_SHARE"/*.bz2 1> /dev/null 2>&1; then
            bzip2 -d "$RELEASE_SHARE"/*.bz2
          fi

          NOTICE_FILE="$RELEASE_DIR/NOTICE.txt"
          echo "QEMU macOS Release" > "$NOTICE_FILE"
          echo "Version: ${{ needs.check-version.outputs.version_tag }}" >> "$NOTICE_FILE"
          echo "Build Date: $(date)" >> "$NOTICE_FILE"
          echo "Architecture: ${{ matrix.arch }}" >> "$NOTICE_FILE"
          echo "----------------------------------------" >> "$NOTICE_FILE"
          echo "Build Configuration:" >> "$NOTICE_FILE"
          echo "${{ env.BUILD_FLAGS }}" >> "$NOTICE_FILE"
          echo "----------------------------------------" >> "$NOTICE_FILE"
          echo "Compiler Version:" >> "$NOTICE_FILE"
          clang --version | head -n 1 >> "$NOTICE_FILE"
          echo "" >> "$NOTICE_FILE"
          echo "Licensing: GPL/LGPL" >> "$NOTICE_FILE"

          echo "Resolving and Bundling Dynamic Libraries..."
          # Function to bundle dylibs
          bundle_libs() {
            local BINARY="$1"
            local LIBS LIB LIB_NAME TARGET_LIB REAL_LIB RAW_NAME BREW_PREFIX
            
            echo "Processing Binary: $BINARY"
            
            # Ensure binary is writable for install_name_tool
            chmod u+w "$BINARY"
            
            # Ensure RPATH includes executable path so @rpath loads work
            install_name_tool -add_rpath "@executable_path" "$BINARY" 2>/dev/null || true
            
            # Get list of non-system libs
            LIBS=$(otool -L "$BINARY" | awk '{print $1}' | grep -vE "^/usr/lib|^/System/Library|^@executable_path" | sort -u)
            
            for LIB in $LIBS; do
              LIB_NAME=$(basename "$LIB")
              TARGET_LIB="$RELEASE_DIR/bin/$LIB_NAME"
              
              echo "  Found Link: $LIB"
              
              # Resolve real path for the library
              local REAL_LIB=""
              
              # Check local install first (handles internal libs like libslirp)
              if [ -f "$(pwd)/qemu-install/lib/$LIB_NAME" ]; then
                  REAL_LIB="$(pwd)/qemu-install/lib/$LIB_NAME"
              # Fallback: Search in build dir (e.g. subprojects/slirp)
              elif [ -n "$(find "$BUILD_DIR" -name "$LIB_NAME" -print -quit 2>/dev/null)" ]; then
                  REAL_LIB="$(find "$BUILD_DIR" -name "$LIB_NAME" -print -quit 2>/dev/null)"
              elif [[ "$LIB" == @rpath* ]]; then
                 # Attempt to find the lib in standard brew locations or install dir
                 local RAW_NAME="${LIB#@rpath/}"
                 # Try to find it in brew lib
                 local BREW_PREFIX=$(brew --prefix)
                 if [ -f "$BREW_PREFIX/lib/$RAW_NAME" ]; then
                    REAL_LIB="$BREW_PREFIX/lib/$RAW_NAME"
                 elif [ -f "$BREW_PREFIX/opt/$RAW_NAME" ]; then # Some might be in opt
                    REAL_LIB="$BREW_PREFIX/opt/$RAW_NAME"
                 fi
              else
                 # Absolute path or relative path
                 if [ -f "$LIB" ]; then
                   REAL_LIB="$LIB"
                 elif [ -f "/opt/homebrew/lib/$LIB_NAME" ]; then
                   REAL_LIB="/opt/homebrew/lib/$LIB_NAME"
                 elif [ -f "/usr/local/lib/$LIB_NAME" ]; then
                   REAL_LIB="/usr/local/lib/$LIB_NAME"
                 fi
              fi

              if [ -n "$REAL_LIB" ]; then
                  if [ ! -f "$TARGET_LIB" ]; then
                    echo "    Copying $LIB_NAME from $REAL_LIB..."
                    cp -L "$REAL_LIB" "$TARGET_LIB"
                    chmod u+w "$TARGET_LIB" # Make the new lib writable
                    
                    # Recursively process this new lib
                    bundle_libs "$TARGET_LIB"
                  fi
                  
                  # Re-link the binary/lib to use the local copy
                  echo "    Run: install_name_tool -change $LIB @executable_path/$LIB_NAME $(basename $BINARY)"
                  if install_name_tool -change "$LIB" "@executable_path/$LIB_NAME" "$BINARY"; then
                      echo "    Success."
                  else
                      echo "    FAILED to patch $LIB_NAME in $BINARY"
                      exit 1
                  fi
              else
                  echo "  WARNING: Could not resolve library: $LIB"
              fi
            done
          }
          

          
          # Bundle for Executables
          bundle_libs "$RELEASE_DIR/bin/qemu-system-${{ matrix.arch }}"
          bundle_libs "$RELEASE_DIR/bin/qemu-img"
          
          # Fix ID of the libs themselves
          echo "Fixing Library IDs..."
          for LIB in "$RELEASE_DIR/bin"/*.dylib; do
             if [ -f "$LIB" ]; then
               LIB_NAME=$(basename "$LIB")
               install_name_tool -id "@executable_path/$LIB_NAME" "$LIB"
             fi
          done

          echo "Ad-hoc Signing..."
          # Strip extended attributes to avoid 'resource fork' errors
          xattr -cr "$RELEASE_DIR"
          
          # Create entitlements to allow loading ad-hoc libraries
          cat > entitlements.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.allow-jit</key>
              <true/>
              <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
              <true/>
              <key>com.apple.security.cs.disable-library-validation</key>
              <true/>
              <key>com.apple.security.get-task-allow</key>
              <true/>
              <key>com.apple.security.hypervisor</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # Sign dylibs (No entitlements needed for libs, but timestamp is good)
          find "$RELEASE_DIR" -name "*.dylib" -print0 | while IFS= read -r -d '' file; do
              echo "Signing Library: $file"
              codesign --force --sign - --timestamp "$file"
          done
          
          # Sign executables (With entitlements and runtime)
          find "$RELEASE_DIR" -type f -perm +111 ! -name "*.dylib" -print0 | while IFS= read -r -d '' file; do
              echo "Signing Executable: $file"
              codesign --force --sign - --entitlements entitlements.plist --options runtime --timestamp "$file"
          done

          echo "Collecting Licenses..."
          [ -f "$SRC_DIR/COPYING" ] && cp "$SRC_DIR/COPYING" "$LICENSE_DIR/QEMU_COPYING.txt"
          [ -f "$SRC_DIR/COPYING.LIB" ] && cp "$SRC_DIR/COPYING.LIB" "$LICENSE_DIR/QEMU_COPYING.LIB.txt"
          [ -f "$SRC_DIR/LICENSE" ] && cp "$SRC_DIR/LICENSE" "$LICENSE_DIR/QEMU_LICENSE.txt"
          cp "LICENSE" "$LICENSE_DIR/BUILD_REPO_LICENSE.txt" || true
          cp "README.md" "$RELEASE_DIR/" || true

          echo "Compressing..."
          tar -C "$RELEASE_DIR" -cf - . | zstd -19 -T0 -o "$ARCHIVE_NAME"
          
          echo "artifact_path=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-macos-${{ matrix.arch }}
          path: ${{ env.artifact_path }}
          retention-days: 1


  build-and-release-linux:
    needs: [check-version, download-source]
    if: needs.check-version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-22.04
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential python3 ninja-build \
            libglib2.0-dev libpixman-1-dev libslirp-dev \
            pkg-config ccache libzstd-dev patchelf bzip2 \
            libfdt-dev

      - name: Restore CCache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-linux-x86_64-${{ github.sha }}
          restore-keys: ccache-linux-x86_64-

      - name: Download Source Artifact
        uses: actions/download-artifact@v4
        with:
          name: qemu-source
          path: .

      - name: Download and Configure
        id: build-prep
        env:
          VERSION: ${{ needs.check-version.outputs.version_num }}
        run: |
          export CCACHE_DIR="$(pwd)/.ccache"
          export CCACHE_COMPRESS=1
          export CCACHE_MAXSIZE=500M
          mkdir -p .ccache
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV
          echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
          
          export CC="ccache gcc"
          export CXX="ccache g++"

          # Source downloaded from artifact
          
          tar -xf qemu-source.tar.xz --exclude="*/roms/*" --exclude="*/tests/lcitool/*" || echo "Tar warning: Symlinks failed, proceeding..."
          
          mv "qemu-${VERSION}" qemu-src
          
          cd qemu-src
          mkdir build
          cd build
          
          INSTALL_DIR="$(pwd)/qemu-install"
          
          FLAGS="--prefix=$INSTALL_DIR \
          --target-list=x86_64-softmmu \
          --enable-kvm \
          --enable-slirp \
          --disable-user \
          --disable-sdl \
          --disable-gtk \
          --disable-curses \
          --disable-vnc \
          --disable-gnutls \
          --disable-glusterfs \
          --disable-libnfs \
          --disable-libiscsi \
          --disable-rbd \
          --disable-xen \
          --disable-docs \
          --disable-debug-info \
          --disable-capstone \
          --disable-libssh \
          --disable-snappy \
          --disable-bzip2 \
          --disable-lzo \
          --disable-zstd \
          --disable-seccomp \
          --disable-guest-agent \
          --disable-vte \
          --disable-spice \
          --disable-curl \
          --disable-smartcard \
          --disable-usb-redir \
          --disable-libusb \
          --disable-opengl \
          --disable-virglrenderer \
          --disable-iconv \
          --disable-dbus-display \
          --disable-nettle \
          --disable-hv-balloon \
          --disable-png \
          --extra-cflags=-O2 \
          --extra-ldflags=-s"

          echo "BUILD_FLAGS=$FLAGS" >> $GITHUB_ENV
          
          ../configure $FLAGS

      - name: Build QEMU
        run: |
          cd qemu-src/build
          ccache -z
          ninja qemu-system-x86_64 -j$(nproc)
          ninja qemu-img -j$(nproc)
          ccache -s

      - name: Package and Bundle
        run: |
          SRC_DIR="qemu-src"
          BUILD_DIR="qemu-src/build"
          RELEASE_DIR="qemu-release"
          LICENSE_DIR="$RELEASE_DIR/licenses"
          ARCHIVE_NAME="qemu-linux-x86_64-${{ needs.check-version.outputs.version_tag }}.tar.zst"
          
          echo "Preparing release dir..."
          rm -rf "$RELEASE_DIR"
          mkdir -p "$RELEASE_DIR/bin"
          mkdir -p "$RELEASE_DIR/share/qemu"
          mkdir -p "$RELEASE_DIR/lib"
          mkdir -p "$LICENSE_DIR"

          echo "Copying core binaries..."
          cp "$BUILD_DIR/qemu-system-x86_64" "$RELEASE_DIR/bin/"
          cp "$BUILD_DIR/qemu-img" "$RELEASE_DIR/bin/"
          
          echo "Copying firmware..."
          BIOS_SRC="$SRC_DIR/pc-bios"
          FIRMWARE_DIR="$RELEASE_DIR/share/qemu"
          
          # Basic BIOS/UEFI
          cp "$BIOS_SRC/bios-256k.bin" "$FIRMWARE_DIR/"
          cp "$BIOS_SRC/bios.bin" "$FIRMWARE_DIR/"
          
          # EDK2 (Compressed)
          # Often upstream tarball has them compressed
          cp "$BIOS_SRC/edk2-x86_64-code.fd.bz2" "$FIRMWARE_DIR/"
          cp "$BIOS_SRC/edk2-i386-vars.fd.bz2" "$FIRMWARE_DIR/"
          
          # KVM/VAPIC
          cp "$BIOS_SRC/kvmvapic.bin" "$FIRMWARE_DIR/"
          cp "$BIOS_SRC/multiboot.bin" "$FIRMWARE_DIR/"
          
          # Linux Boot
          cp "$BIOS_SRC/linuxboot.bin" "$FIRMWARE_DIR/"
          cp "$BIOS_SRC/linuxboot_dma.bin" "$FIRMWARE_DIR/"
          
          # VGA BIOSes
          cp "$BIOS_SRC"/vgabios*.bin "$FIRMWARE_DIR/"
          
          # Network Boot (PXE/EFI)
          cp "$BIOS_SRC"/efi-*.rom "$FIRMWARE_DIR/"
          cp "$BIOS_SRC"/pxe-*.rom "$FIRMWARE_DIR/"
          
          # Decompress any bz2 files
          if ls "$FIRMWARE_DIR"/*.bz2 1> /dev/null 2>&1; then
            bzip2 -d "$FIRMWARE_DIR"/*.bz2
          fi

          echo "Bundling Dependencies..."
          LIBS_DIR="$RELEASE_DIR/lib"
          
          bundle_deps() {
             local BIN="$1"
             echo "Processing $BIN..."
             # Get dependencies, exclude vdso, linux-vdso, ld-linux, etc.
             DEPS=$(ldd "$BIN" | awk '{print $3}' | grep "^/" | grep -v "ld-linux")
             
             for LIB in $DEPS; do
                 LIB_NAME=$(basename "$LIB")
                 TARGET_LIB="$LIBS_DIR/$LIB_NAME"
                 
                 if [ ! -f "$TARGET_LIB" ]; then
                     echo "  Bundling $LIB_NAME..."
                     cp -L "$LIB" "$TARGET_LIB"
                 fi
             done
             
             echo "  Patching RPATH..."
             patchelf --set-rpath '$ORIGIN/../lib' "$BIN"
          }
          
          bundle_deps "$RELEASE_DIR/bin/qemu-system-x86_64"
          bundle_deps "$RELEASE_DIR/bin/qemu-img"

          NOTICE_FILE="$RELEASE_DIR/NOTICE.txt"
          echo "QEMU Linux Release" > "$NOTICE_FILE"
          echo "Version: ${{ needs.check-version.outputs.version_tag }}" >> "$NOTICE_FILE"
          echo "Build Date: $(date)" >> "$NOTICE_FILE"
          echo "Architecture: x86_64" >> "$NOTICE_FILE"
          echo "----------------------------------------" >> "$NOTICE_FILE"
          echo "Build Configuration:" >> "$NOTICE_FILE"
          echo "${{ env.BUILD_FLAGS }}" >> "$NOTICE_FILE"
          echo "----------------------------------------" >> "$NOTICE_FILE"
          echo "Compiler Version:" >> "$NOTICE_FILE"
          gcc --version | head -n 1 >> "$NOTICE_FILE"
          echo "" >> "$NOTICE_FILE"
          echo "Licensing: GPL/LGPL" >> "$NOTICE_FILE"
          
          echo "Collecting Licenses..."
          [ -f "$SRC_DIR/COPYING" ] && cp "$SRC_DIR/COPYING" "$LICENSE_DIR/QEMU_COPYING.txt"
          [ -f "$SRC_DIR/COPYING.LIB" ] && cp "$SRC_DIR/COPYING.LIB" "$LICENSE_DIR/QEMU_COPYING.LIB.txt"
          [ -f "$SRC_DIR/LICENSE" ] && cp "$SRC_DIR/LICENSE" "$LICENSE_DIR/QEMU_LICENSE.txt"
          cp "LICENSE" "$LICENSE_DIR/BUILD_REPO_LICENSE.txt" || true
          cp "README.md" "$RELEASE_DIR/" || true

          echo "Compressing..."
          tar -C "$RELEASE_DIR" -cf - . | zstd -19 -T0 -o "$ARCHIVE_NAME"
          
          echo "artifact_path=$ARCHIVE_NAME" >> $GITHUB_ENV

      - name: Upload Release Assets
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-linux
          path: ${{ env.artifact_path }}
          retention-days: 1

  test-release-macos:
    needs: build-and-release-macos
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-15-intel
            arch: x86_64
          - os: macos-latest
            arch: aarch64
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-assets-macos-${{ matrix.arch }}
          path: .

      - name: Install Dependencies
        run: brew install zstd

      - name: Verify Bundle
        run: |
          mkdir qemu-test
          zstd -d -c *.tar.zst | tar -xf - -C qemu-test
          cd qemu-test/bin
          
          echo "Checking linkage..."
          otool -L qemu-system-${{ matrix.arch }}
          
          echo "Verifying Code Signature..."
          codesign -dv -r- qemu-system-${{ matrix.arch }}
          codesign -d --entitlements - qemu-system-${{ matrix.arch }}
          
          echo "Running --version..."
          ./qemu-system-${{ matrix.arch }} --version


  test-release-linux:
    needs: build-and-release-linux
    runs-on: ubuntu-22.04
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: release-assets-linux
          path: .

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y zstd

      - name: Verify Bundle
        run: |
          mkdir qemu-test
          zstd -d -c *.tar.zst | tar -xf - -C qemu-test
          cd qemu-test/bin
          
          echo "Checking linkage..."
          ldd qemu-system-x86_64
          
          echo "Running --version..."
          ./qemu-system-x86_64 --version


  publish-release:
    needs: [check-version, build-and-release-windows, test-release-macos, test-release-linux]
    if: needs.check-version.outputs.should_build == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-assets-*
          path: release-assets
          merge-multiple: true

      - name: Get Date
        id: date
        run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      - name: Publish Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.RELEASE_TOKEN }}
          tag_name: ${{ needs.check-version.outputs.version_tag }}
          name: QEMU ${{ needs.check-version.outputs.version_tag }} (All Platforms)
          body: |
            # üöÄ QEMU ${{ needs.check-version.outputs.version_tag }} Release

            Automated multi-platform build of QEMU ${{ needs.check-version.outputs.version_tag }} for Marten.

            ## üì¶ Downloads
            | Platform | Architecture | File |
            |----------|--------------|------|
            | **Windows** | x86_64 | `qemu-windows-x86_64-*.tar.zst` |
            | **macOS** | x86_64 (Intel) | `qemu-macos-x86_64-*.tar.zst` |
            | **macOS** | aarch64 (Apple Silicon) | `qemu-macos-aarch64-*.tar.zst` |
            | **Linux** | x86_64 | `qemu-linux-x86_64-*.tar.zst` |

            ## üõ†Ô∏è Features
            - **Optimization**: `-O2` for balanced performance.
            - **Firmware**: Includes BIOS, UEFI (EDK2), and network boot ROMs.
            - **Acceleration**:
              - Windows: WHPX (Hyper-V)
              - macOS: HVF (Hypervisor.framework)
              - Linux: KVM

            ```bash
            tar -I zstd -xf qemu-*.tar.zst
            ```

            *Build Date: ${{ steps.date.outputs.date }}*
          files: release-assets/**/*.tar.zst

